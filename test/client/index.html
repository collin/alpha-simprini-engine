<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Alpha Simprini Engine Client Tests</title>
  <link rel="stylesheet" href="/qunit/qunit.css">
</head>
<body>
  <style type="text/css">
    .stack-item-container * { margin: 0; padding: 0; }
  </style>
  <div id="qunit"></div>
  <div id="qunit-fixture"></div>
  <!-- QUNIT SCRIPTS -->
  <script src="/qunit/qunit.js"></script>
  <script src="/qunit/coffee-script.js"></script>

  <!-- DEPENDENCIES -->
  <script src="/javascripts/jquery.js"></script>
  <script src="/javascripts/underscore.js"></script>
  <script src="/javascripts/backbone.js"></script>

  <!-- Library under test -->
  <script src="/source/index.js.coffee" type="text/coffeescript"></script>

  <!-- TEST HELPERS -->
  <script type="text/coffeescript">
    class window.MockHistory
      pushState: (@state, title, url) ->
      replaceState: (@state, title, url) ->

    helper = (name, fn) -> window[name] = fn
    helper 'makeStackView', (stack=(new Stacker.Cards)) ->
      view = new Stacker.StackView model:stack, header: $("<header>")
      view.render()

    helper 'makeHistoryController', ->
      view = makeStackView()
      controller = new Stacker.HistoryController(view.model, new MockHistory)

    helper 'matchModels', (list1, list2) ->
      deepEqual _.invoke(list1, 'toString'), _.invoke(list2, 'toString')
  </script>

  <!-- Tests of library -->
  <script src="/stacker/cards.coffee" type="text/coffeescript"></script>
  <script src="/stacker/view.coffee" type="text/coffeescript"></script>
  <script src="/stacker/stack_view.coffee" type="text/coffeescript"></script>
  <script src="/stacker/history_controller.coffee" type="text/coffeescript"></script>
  <script src="/stacker/navigation_controller.coffee" type="text/coffeescript"></script>
  <script src="/stacker/app.coffee" type="text/coffeescript"></script>

  <!-- cut off history api -->
  <script type="text/coffeescript">
    $(window).on "popstate", (event) -> event.preventDefault()
  </script>

  <!-- WebSocket to reload this file upon changes to test/library. -->
  <script type="text/coffeescript">
    window.socket = new WebSocket "ws://#{window.location.host}/control"
    socket.onmessage = (event) -> 
      window.location = window.location.href.replace(/\??&cb=0.\d+/g, '') + "?&cb=#{Math.random()}"
  </script>
</body>
</html>